# SHARDING

> DB 트래픽을 분산 처리하기 위해서 사용하는 기술 중 하나이다. 하나의 DB에 데이터가 늘어나면 용량 이슈도 생기고, 느려지는 CRUD는 자연스레 서비스 성능에 영향을 주기 때문이다.
>
> 우아한형제들 기술 블로그에 송재욱님, 전병두님이 작성하신 글에서 자세하게 알아볼 수 있다. https://techblog.woowahan.com/2687/

### DB 분산 처리의 장점

특정 DB의 장애가 전면장애로 이어지지 않는다. (물론 보통 HA구성으로 페일오버되도록 설계한다.)



### 요구사항

- 라우팅을 위해 구분할 수 있는 유일한 키값이 있어야 한다.(편의상 아래부터는 PK 또는 샤딩키라고 부릅니다.)
- 올바른 DB를 찾을 수 있도록 라우팅이 돼야 한다.
- 설정으로 쉽게 증설이 가능해야 한다.



> 모듈러샤딩과 레인지샤딩은 장단점이 명확하며 상호배타적인 성격을 갖는다. 따라서 DB마다 예측 가능한 데이터 성질에 따라 방식을 선택하는 것이 중요하다.

### Modular sharding

![properties](https://techblog.woowahan.com/wp-content/uploads/img/2020-07-06/thiiing-db-modular-sharding.png)
모듈러샤딩은 PK를 모듈러 연산한 결과로 DB를 특정하는 방식입니다. 간략한 장단점은 아래와 같습니다.

- 장점 : 레인지샤딩에 비해 데이터가 균일하게 분산됩니다.
- 단점 : DB를 추가 증설하는 과정에서 이미 적재된 데이터의 재정렬이 필요합니다.

모듈러샤딩은 데이터량이 일정 수준에서 유지될 것으로 예상되는 데이터 성격을 가진 곳에 적용할 때 어울리는 방식입니다.
띠잉 서비스의 콘텐츠 관리 정책을 예로 들면, 서비스 오픈 시점에는 콘텐츠의 유지기간이 24시간으로 제한돼 있었습니다.
따라서 데이터가 항상 쌓이기만 하는 상황은 아니었고, 이런 경우 모듈러 샤딩을 적용하기에 알맞습니다. (여담으로 현재는 이 정책이 완화되어 무기한 보존이 가능합니다.)
물론 데이터가 꾸준히 늘어날 수 있는 경우라도 적재속도가 그리 빠르지 않다면 모듈러방식을 통해 분산처리하는 것도 고려해볼 법 합니다.
무엇보다 데이터가 균일하게 분산된다는 점은 트래픽을 안정적으로 소화하면서도 DB리소스를 최대한 활용할 수 있는 방법이기 때문입니다.

### Range sharding

![properties](https://techblog.woowahan.com/wp-content/uploads/img/2020-07-06/thiiing-db-range-sharding.png)
레인지샤딩은 PK의 범위를 기준으로 DB를 특정하는 방식입니다. 간략한 장단점은 아래와 같습니다.

- 장점 : 모듈러샤딩에 비해 기본적으로 증설에 재정렬 비용이 들지 않습니다.
- 단점 : 일부 DB에 데이터가 몰릴 수 있습니다.

레인지샤딩의 가장 큰 장점은 증설작업에 드는 비용이 크지 않다는 점입니다. 데이터가 급격히 증가할 여지가 있다면 레인지방식도 좋은 선택일겁니다.
다만 단점을 무시할 수 없는데요. 주로 활성유저가 몰린 DB로 트래픽이나 데이터량이 몰릴 수 있기 때문입니다.
기껏 분산처리를 했는데 이런 상황이 발생하면 또다시 부하분산을 위해 해당 DB를 쪼개 재정렬하는 작업이 필요하고, 반대로 트래픽이 저조한 DB는 통합작업을 통해 유지비용을 아끼도록 관리해야 합니다.

### Router

모듈러와 레인지방식이 어떤 기준으로 데이터를 분산시킬지에 대한 명세를 정의한 것이라면, 실제로 분산된 DB에 접근하기 위한 논리적인 작업은 라우터가 담당하게 됩니다.